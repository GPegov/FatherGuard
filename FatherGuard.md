# Юридический сервис "Защита Отцов" - Документация

## Обзор проекта
Проект представляет собой веб-приложение для анализа юридических документов и автоматического формирования жалоб в государственные органы. Основные технологии:
- **Frontend**: Vue 3 (Composition API), Pinia, Vue Router, Vite
- **Backend**: Node.js (v24.5.0)
- **AI**: Локальная LLM модель (llama3.1:latest) через Ollama

## Основные функциональные блоки

### 1. Загрузка и анализ документов
- Загрузка PDF/TXT документов пользователем
- Извлечение текста из документов
- Анализ текста локальной LLM моделью
- Сохранение структурированных данных в `db.json`

### 2. Формирование жалоб
- Анализ юридических нарушений в документах
- Генерация жалоб в выбранные ведомства
- Сохранение жалоб с привязкой к исходным документам

### 3. Управление документами
- Просмотр списка документов
- Детальный просмотр и редактирование
- Удаление документов

### 4. Управление жалобами
- Просмотр списка сгенерированных жалоб
- Экспорт жалоб в TXT/DOC форматах
- Удаление жалоб

## Архитектура проекта

### Фронтенд структура

#### Главные компоненты:
- `App.vue` - Корневой компонент с навигацией
- `views/` - Страницы приложения:
  - `HomeView.vue` - Главная страница загрузки документов
  - `DocumentReview.vue` - Предпросмотр и редактирование документа
  - `DocumentsList.vue` - Список всех документов
  - `ComplaintForm.vue` - Форма генерации жалобы
  - `ComplaintsList.vue` - Список сгенерированных жалоб
  - `DocumentDetail.vue` - Детали документа

#### Хранилища (Pinia):
- `documentStore.js` - Управление документами
- `complaintStore.js` - Управление жалобами
- `aiStore.js` - Взаимодействие с AI моделью

#### Вспомогательные компоненты:
- `FileUpload.vue` - Компонент загрузки файлов
- `NotificationToast.vue` - Уведомления

### Бекенд структура

#### Основные модули:
- `services/aiService.js` - Основной сервис работы с AI моделью
- `services/pdfService.js` - Извлечение текста из PDF
- `routes/documentRoutes.js` - API для работы с документами
- `routes/complaintRoutes.js` - API для работы с жалобами

#### Модели:
- `models/Document.js` - Модель документа
- `models/Complaint.js` - Модель жалобы

## Детальное описание ключевых файлов

### Frontend

#### Хранилища (Pinia)

**documentStore.js**:
- Управление состоянием документов
- Методы:
  - `fetchDocuments()` - Загрузка списка документов
  - `uploadFiles()` - Загрузка файлов
  - `analyzeDocument()` - Анализ документа через AI
  - `saveDocument()` - Сохранение документа

**complaintStore.js**:
- Управление состоянием жалоб
- Методы:
  - `generateComplaint()` - Генерация жалобы
  - `exportComplaint()` - Экспорт жалобы
  - `fetchComplaints()` - Загрузка списка жалоб

**aiStore.js**:
- Взаимодействие с локальной LLM
- Методы:
  - `checkServerStatus()` - Проверка статуса AI-сервера

#### Компоненты

**HomeView.vue**:
- Главная страница загрузки документов
- Использует `FileUpload.vue` для загрузки файлов
- Передает данные в `documentStore`

**DocumentReview.vue**:
- Предпросмотр документа перед сохранением
- Редактирование полей документа
- Кнопка анализа документа
- Кнопка сохранения документа

**DocumentsList.vue**:
- Отображение списка документов
- Кнопки:
  - Анализировать документ
  - Удалить документ
  - Сформировать жалобу

**ComplaintForm.vue**:
- Форма генерации жалобы
- Выбор ведомства
- Просмотр сгенерированной жалобы

**ComplaintsList.vue**:
- Список сгенерированных жалоб
- Кнопки экспорта в TXT/DOC

### Backend

**aiService.js**:
- Основной класс `AIService` для работы с моделью
- Методы:
  - `analyzeLegalText()` - Анализ юридического текста
  - `generateUnifiedComplaint()` - Генерация жалобы
  - `analyzeAttachment()` - Анализ вложений

**documentRoutes.js**:
- API endpoints:
  - `POST /upload` - Загрузка документов
  - `POST /analyze` - Анализ документа
  - `GET /` - Получение списка документов
  - `GET /:id` - Получение документа по ID
  - `PUT /:id` - Обновление документа
  - `DELETE /:id` - Удаление документа
  - `POST /:id/analyze` - Анализ документа по ID

**complaintRoutes.js**:
- API endpoints:
  - `POST /generate` - Генерация жалобы
  - `GET /export` - Экспорт жалобы
  - `GET /` - Получение списка жалоб
  - `DELETE /:id` - Удаление жалобы

## Пайплайн обработки документа

1. Пользователь загружает документ через `HomeView.vue`
2. Документ передается в `documentStore` без автоматического сохранения
3. Для PDF вызывается `pdfService.extractTextFromPdf()`
4. Пользователь переходит в `DocumentReview.vue` для предпросмотра
5. При необходимости анализируется через `documentStore.analyzeDocument()`
6. Пользователь нажимает "Сохранить документ" для фактического сохранения
7. При необходимости генерируется жалоба через `complaintStore.generateComplaint()`
8. Жалоба сохраняется и может быть экспортирована

## Структура db.json

```json
{
  "documents": [
    {
      "id": "uuid",
      "date": "YYYY-MM-DD",
      "agency": "Ведомство",
      "originalText": "Текст документа",
      "summary": "Краткая суть",
      "keySentences": ["Цитата 1", "Цитата 2"],
      "documentDate": "Дата документа",
      "senderAgency": "Ведомство-отправитель",
      "attachments": [
        {
          "id": "uuid",
          "name": "filename.pdf",
          "text": "Текст вложения",
          "analysis": { ... }
        }
      ],
      "complaints": ["complaint_id1", "complaint_id2"],
      "analysisStatus": "completed",
      "lastAnalyzedAt": "timestamp",
      "createdAt": "timestamp",
      "updatedAt": "timestamp",
      "violations": ["Нарушение 1", "Нарушение 2"]
    }
  ],
  "complaints": [
    {
      "id": "uuid",
      "documentId": "document_id",
      "agency": "Ведомство для жалобы",
      "content": "Текст жалобы",
      "createdAt": "timestamp",
      "updatedAt": "timestamp"
    }
  ]
}
```

## Взаимодействие компонентов

```
[HomeView] → [documentStore] → [DocumentReview] (без сохранения)
                     ↓
            [Пользователь нажимает "Сохранить"]
                     ↓
               [Backend API] → [db.json]
                     ↓
[DocumentsList] → [ComplaintForm] → [complaintStore] → [Backend API]
                     ↓
            [ComplaintsList] ← [db.json]
```

## Особенности реализации

### Работа с файлами:

- Поддержка PDF и TXT форматов
- Ограничение на размер файлов
- Извлечение текста на бекенде

### AI интеграция:

- Локальная модель через Ollama
- Кеширование запросов
- Обработка ошибок соединения
- Оптимизированная передача данных (только необходимый текст)

### Безопасность:

- Валидация входных данных
- Обработка ошибок на всех уровнях
- Защита от перегрузки модели

### Производительность:

- Оптимизированные запросы к модели (передача только текста)
-Ленивая загрузка компонентов
- Кеширование результатов анализа
- Исключение лишних сохранений документов

### Архитектурные улучшения:

- Централизация логики работы с AI на бэкенде
- Устранение дублирования функционала между фронтендом и бэкендом
- Единая точка входа для всех AI-запросов
- Унифицированные форматы данных между фронтендом и бэкендом
- Явный контроль над сохранением документов (только по запросу пользователя)